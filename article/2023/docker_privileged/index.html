<!doctype html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=author content="白菜"><meta property="og:url" content="https://blog.baicai.me/article/2023/docker_privileged/"><link rel=canonical href=https://blog.baicai.me/article/2023/docker_privileged/><style type=text/css>body{font-family:monospace}</style><title>Docker的 privileged 选项解析（特权模式：赋予容器几乎与主机相同的权限）</title>
<meta name=author content="白菜"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href="/css/baicai_custom.css?rnd=1727179349"></head><body><header>============<br>== <a href=https://blog.baicai.me/>白菜</a> ==<br>============<div style=float:right>一个勤奋的代码搬运工!</div><br><p><nav><a href=/><b>Start</b></a>.
<a href=/posts/><b>文章</b></a>.
<a href=/categories/><b>分类</b></a>.
<a href=/tags/><b>标签</b></a>.
<a href=/about/><b>关于</b></a>.</nav></p></header><main><article><h1>Docker的 privileged 选项解析（特权模式：赋予容器几乎与主机相同的权限）</h1><b><time>2023.11.17 22:52</time></b>
<a href=/tags/docker>Docker</a><div><h3 id=runtime-privilege-and-linux-capabilities>Runtime privilege and Linux capabilities</h3><p>参考官方文档：<a href=https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities>Docker run reference</a></p><p>By default, Docker containers are &ldquo;unprivileged&rdquo; and cannot, for example, run a Docker daemon inside a Docker container. This is because by default a container is not allowed to access any devices, but a &ldquo;privileged&rdquo; container is given access to all devices (see the documentation on cgroups devices).</p><p>The &ndash;privileged flag gives all capabilities to the container. When the operator executes docker run &ndash;privileged, Docker will enable access to all devices on the host as well as set some configuration in AppArmor or SELinux to allow the container nearly all the same access to the host as processes running outside containers on the host. Additional information about running with &ndash;privileged is available on the <a href=https://www.docker.com/blog/docker-can-now-run-within-docker/>Docker Blog</a>.</p><h2 id=docker-容器的安全性>Docker 容器的安全性</h2><h3 id=linux-namespace-和-capabilities>Linux Namespace 和 Capabilities</h3><p>Docker使用Linux namespace和capabilities来实现容器隔离和限制权限。</p><pre><code>Linux Namespace：Docker利用namespace技术，使得每个容器都有其自己的进程、网络、挂载、用户ID等独立的空间。这保证了容器与容器之间以及容器与主机之间的隔离性。

Capabilities：Linux capabilities允许将传统的root权限分割成多个不同的能力，例如CAP_NET_ADMIN能力允许操作网络配置，CAP_CHOWN能力允许改变文件所有权。Docker默认情况下会赋予容器一些必要的capabilities，但不包括全部的能力，从而降低了被攻击的风险。
</code></pre><p>Docker 通过 &ndash;cap-add 和 &ndash;cap-drop 两个参数，可以灵活地添加或删除容器的 capabilities。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run --cap-add<span style=color:#f92672>=</span>SYS_PTRACE --rm -it alpine
</span></span></code></pre></div><p>上面 <code>--cap-add=SYS_PTRACE</code> 的意思就是：给容器添加 SYS_PTRACE 权限，允许容器内的进程可以 ptrace 和 debug 其他进程。</p><h3 id=docker限制和权限>Docker限制和权限</h3><p>在默认情况下，Docker对容器的权限进行了严格的限制，只提供了有限的capabilities。此外，许多系统级别的操作（例如挂载文件系统、修改内核参数等）都是被禁止的。这种安全模型使得Docker可以在不牺牲安全性的前提下，实现轻量级的虚拟化。</p><p>然而，在某些情况下，我们可能需要赋予容器更多的权限。例如，如果我们需要在容器中运行一些需要特权的服务（如网络设备管理、硬件设备接口等），那么默认的权限可能就不够用了。这时候，<code>--privileged=true</code> 选项就派上了用场。</p><h4 id=docker的privilegedtrue选项>Docker的–privileged=true选项</h4><p>当使用&ndash;privileged=true选项运行容器时，Docker会赋予容器几乎与主机相同的权限。
具体来说，这个选项做了以下两件事情：</p><pre tabindex=0><code>    给容器添加了所有的capabilities
    允许容器访问主机的所有设备
</code></pre><h4 id=--privilegedtrue的风险>&ndash;privileged=true的风险</h4><p>尽管 <code>--privileged=true</code> 选项为容器提供了强大的功能，但它也带来了一些严重的安全隐患。由于privileged容器具有几乎与主机相同的权限，所以如果容器被恶意代码控制，那么攻击者就可以轻易地突破容器的边界，对主机进行任意操作。</p><p>因此，我们需要谨慎地使用 <code>--privileged=true</code> 选项，只在真正需要的情况下才启用它。在可能的情况下，我们应该尽量使用其他更细粒度的权限控制手段，例如通过<code>--cap-add</code>或<code>--device</code>参数来分别添加必要的capabilities或设备访问权限。</p><h4 id=细粒度的权限控制手段>细粒度的权限控制手段</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 添加单个capability</span>
</span></span><span style=display:flex><span>docker run --rm --cap-add NET_ADMIN -it alpine sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 添加设备访问权限</span>
</span></span><span style=display:flex><span>docker run --device<span style=color:#f92672>=</span>/dev/sda:/dev/xvdc -it alpine
</span></span></code></pre></div><h4 id=docker-compose-参考>docker-compose 参考</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;3&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>baicai_image</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>:  <span style=color:#ae81ff>debian</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#e6db74>&#34;baicai_image&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>unless-stopped</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>: <span style=color:#ae81ff>run -c /app/config.json</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./config.json:/app/config.json</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>TZ</span>: <span style=color:#ae81ff>Asia/Shanghai</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;80:80&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>privileged</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>cap_add</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>NET_ADMIN</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>SYS_MODULE</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>SYS_PTRACE</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>SYS_ADMIN</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>NET_RAW</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>cap_drop</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>ALL</span>
</span></span></code></pre></div><h3 id=附注-在docker-debian容器中安装pstop等命令>附注: 在Docker Debian容器中安装ps、top等命令</h3><p>debian镜像默认没有包括进程管理相关工具，在实际使用时可能有些麻烦，如果需要也可以自己安装，使用如下命令。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>apt update <span style=color:#f92672>&amp;&amp;</span> apt install -y procps
</span></span></code></pre></div></div></article></main><aside><div><div><h3>LATEST POSTS</h3></div><div><ul><li><a href=/article/2024/fmt_int/>Go语言进制以及进制转换</a></li><li><a href=/article/2024/cmd_sqlite/>Mac终端查看sqlite3数据库</a></li><li><a href=/article/2024/debian_ufw_docker/>解决 UFW 和 Docker 的问题</a></li><li><a href=/article/2024/docker_ports/>docker 映射某个范围内的端口列表</a></li><li><a href=/article/2024/adb_push_pull/>使用adb命令和电脑互传文件</a></li></ul></div></div></aside><footer><p>&copy; 2024 <a href=https://blog.baicai.me/><b>baicai.me</b></a>.
<a href=/links/><b>友情链接</b></a>.
<a href=/index.xml><b>RSS</b></a>.</p></footer></body></html>