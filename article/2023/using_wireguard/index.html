<!doctype html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=author content="白菜"><meta property="og:url" content="https://blog.baicai.me/article/2023/using_wireguard/"><link rel=canonical href=https://blog.baicai.me/article/2023/using_wireguard/><style type=text/css>body{font-family:monospace}</style><title>通过 WireGuard 搭建 VPN 访问家里内网</title>
<meta name=description content="一个勤奋的代码搬运工!"><meta name=author content="白菜"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href="/css/baicai_custom.css?rnd=1743157893"></head><body><header>============<br>== <a href=https://blog.baicai.me/>白菜</a> ==<br>============<div style=float:right>一个勤奋的代码搬运工!</div><br><p><nav><a href=/><b>Start</b></a>.
<a href=/posts/><b>文章</b></a>.
<a href=/categories/><b>分类</b></a>.
<a href=/tags/><b>标签</b></a>.
<a href=/about/><b>关于</b></a>.</nav></p></header><main><article><h1>通过 WireGuard 搭建 VPN 访问家里内网</h1><b><time>2023.10.08 15:19</time></b>
<a href=/tags/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB>技术分享</a>
<a href=/tags/wireguard>WireGuard</a><div><p>家里网络没有公网 IP，因此需要一台具有公网 IP 的服务器作为 WireGuard 网络的“server”。家中需要有一台设备作为 WireGuard 网络中的节点。我们将使用手机，在 4G 网络下检查 VPN 是否搭建成功。</p><h2 id=ip-段选择>IP 段选择</h2><p>WireGuard 组网需要使用一个不与你的任何设备的网络相冲突的 IP 地址段。像 192.0.2.0/24 、198.51.100.0/24 、203.0.113.0/24 这些分配为用于文档和示例中的“TEST-NET”，这些地址段通常不会被你需要连接的其他网络所使用。</p><p>在下面的配置中，我会分别将 192.0.2.1、192.0.2.2、192.0.2.3 分配给公网服务器、家中的 Mac 和 iPhone。</p><h2 id=在服务器上配置-wireguard>在服务器上配置 WireGuard</h2><p>要使用 WireGuard，首先需要确保 Linux 内核支持。可使用 <code>modinfo wireguard</code> 命令检查是否内置了 WireGuard。也可用过 <code>uname -r</code> 检查内核版本是否为 5.6 以上。</p><h3 id=安装-wireguard>安装 wireguard</h3><p>Debian</p><pre tabindex=0><code>apt install wireguard
</code></pre><p>其他系统参考：<a href=https://www.wireguard.com/install/>install</a></p><h3 id=完成服务器端的配置>完成服务器端的配置</h3><p>在正确安装 wireguard 后，你可以通过如下命令快速创建一组公钥和私钥。</p><pre tabindex=0><code>$ wg genkey | tee peer_A.key | wg pubkey &gt; peer_A.pub &amp;&amp; cat peer_A.key &amp;&amp; cat peer_A.pub
</code></pre><p>创建 <code>/etc/wireguard/wg0.conf</code> 并填配置</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[Interface]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PrivateKey</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>(your server private key here)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Address</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>192.0.2.1/24</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ListenPort</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>51820</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#PreUp = echo WireGuard PreUp</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE; ip6tables -A FORWARD -i wg0  -j ACCEPT; ip6tables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE; ip6tables -D FORWARD -i wg0 -j ACCEPT; ip6tables -t nat -D POSTROUTING -o eth0 -j MASQUERADE</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#PostUp = iptables -I INPUT -p udp --dport 51820 -j ACCEPT</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#PostDown = iptables -D INPUT -p udp --dport 51820 -j ACCEPT</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#ipv4 局域网够用配置</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PostUp</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>iptables -A FORWARD -i wg0 -j ACCEPT</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PostDown</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>iptables -D FORWARD -i wg0 -j ACCEPT</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#ipv4防火墙放行转发和NAT(访问公共网络)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#ipv4防火墙放行转发和NAT(访问公共网络) 扩展防火墙规则(节点之间双向互联)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#PostUp = iptables -I FORWARD -i wg0 -j ACCEPT; iptables -I FORWARD -o wg0 -j ACCEPT; iptables -I INPUT -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -D FORWARD -o wg0 -j ACCEPT; iptables -D INPUT -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#PreDown = echo WireGuard PreDown</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Peer]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Mac at home</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PublicKey</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>(Mac public key here)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>AllowedIPs</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>192.0.2.2/32, 192.168.1.0/24</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Peer]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># iPhone</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PublicKey</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>(iPhone public key here)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>AllowedIPs</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>192.0.2.3/32</span>
</span></span></code></pre></div><p>在 WireGuard 中，你需要手动给各个设备分配 IP，并确保每个设备都有唯一的 IP。Interface 包含了当前设备的设置，对于“服务端”来说，ListenPort 是必须的。下面的每一个 Peer 段代表了能连接到本设备的一个其他设备。</p><p>配置文件保存后，我们可以使用 <code>wg-quick up wg0</code> 来启用配置文件。wg-quick 会自动配置路由表，无需我们手动设置。</p><p>记得放行 51820 UDP 端口。</p><p><a href=/article/2023/oracle_vps_iptables/>iptables 配置参考</a></p><h2 id=家中mac端的配置>家中Mac端的配置</h2><p>创建 <code>/etc/wireguard/wg0.conf</code> 并填配置</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[Interface]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PrivateKey</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>(private key of Mac)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Address</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>192.0.2.2/24</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>DNS</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>1.1.1.1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Peer]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PublicKey</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>(public key of server)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>AllowedIPs</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>192.0.2.0/24</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Endpoint</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>(server ip address):51820</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PersistentKeepalive</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>10</span>
</span></span></code></pre></div><p>在这里，我们将公网服务器作为唯一的 Peer，通过设置 PersistentKeepalive 来进行连接的保活。这里 AllowedIPs 的作用是确保来自于我们 WireGuard 子网网段来的流量能被本机的 WireGuard 虚拟网卡进行处理。</p><h2 id=iphone-配置>iphone 配置</h2><p>安装 WireGuard <a href="https://itunes.apple.com/us/app/wireguard/id1441195209?ls=1&amp;mt=8"> Download from App Store</a></p><p>这个配置可以参考应用商店的截屏。</p><h2 id=设置开机启动>设置开机启动</h2><p>如果你的系统使用systemd,如ubuntu，设置wireguard开机启动命令如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl enable wg-quick@wg0
</span></span></code></pre></div><h2 id=启用服务器peer端转发>启用服务器Peer端转发</h2><p>打开 <code>/etc/sysctl.conf</code> 修改</p><pre tabindex=0><code class=language-conf data-lang=conf>net.ipv4.ip_forward=1
net.ipv6.conf.all.forwarding=1
</code></pre><p>或</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#39;net.ipv4.ip_forward=1&#39;</span> &gt;&gt; /etc/sysctl.conf
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;net.ipv6.conf.all.forwarding=1&#39;</span> &gt;&gt; /etc/sysctl.conf
</span></span><span style=display:flex><span>sysctl -p
</span></span></code></pre></div><h2 id=附注>附注</h2><h3 id=保留地址段>保留地址段</h3><p><a href=https://zh.wikipedia.org/wiki/%E4%BF%9D%E7%95%99IP%E5%9C%B0%E5%9D%80>保留IP地址</a></p><h3 id=小插曲>小插曲</h3><p>当遇到错误提示：</p><pre tabindex=0><code>/usr/bin/wg-quick: line 31: resolvconf: command not found [WireGuard | Debian]
</code></pre><p>可以创建软链接解决</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ln -s /usr/bin/resolvectl /usr/local/bin/resolvconf
</span></span></code></pre></div><p>当遇到错误提示：</p><pre tabindex=0><code>[SELF-SOLVED] Unit dbus-org.freedesktop.resolve1.service not found
</code></pre><p>可以通过启动 systemd-resolved 服务解决</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start systemd-resolved.service
</span></span><span style=display:flex><span>systemctl enable systemd-resolved.service
</span></span></code></pre></div><h3 id=配置详解>配置详解</h3><p>WireGuard 使用 INI 语法作为其配置文件格式。配置文件可以放在任何路径下，但必须通过绝对路径引用。默认路径是 <code>/etc/wireguard/wg0.conf</code>。</p><p>配置文件的命名形式必须为 <code>${WireGuard 接口的名称}.conf</code>。通常情况下 WireGuard 接口名称以 <code>wg</code> 为前缀，并从 <code>0</code> 开始编号，但你也可以使用其他名称，只要符合正则表达式 <code>^[a-zA-Z0-9_=+.-]{1,15}$</code> 就行。</p><p>你可以选择使用 <code>wg</code> 命令来手动配置 VPN，但一般建议使用 <code>wg-quick</code>，它提供了更强大和用户友好的配置体验，可以通过配置文件来管理配置。</p><h4 id=interface>[Interface]</h4><p>定义本地 VPN 配置。例如：</p><p>1.本地节点是客户端，只路由自身的流量，只暴露一个 IP。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[Interface]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Name = phone.example-vpn.dev</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Address</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>192.0.2.5/32</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PrivateKey</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&lt;private key for phone.example-vpn.dev&gt;</span>
</span></span></code></pre></div><p>本地节点是中继服务器，它可以将流量转发到其他对等节点（peer），并公开整个 VPN 子网的路由。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[Interface]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Name = public-server1.example-vpn.tld</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Address</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>192.0.2.1/24</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ListenPort</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>51820</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PrivateKey</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&lt;private key for public-server1.example-vpn.tld&gt;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>DNS</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>1.1.1.1</span>
</span></span></code></pre></div><h4 id=-name># Name</h4><p>这是 INI 语法中的标准注释，用于展示该配置部分属于哪个节点。这部分配置会被 WireGuard 完全忽略，对 VPN 的行为没有任何影响。</p><h4 id=address>Address</h4><p>定义本地节点应该对哪个地址范围进行路由。如果是常规的客户端，则将其设置为节点本身的单个 IP（使用 CIDR 指定，例如 192.0.2.3/32）；如果是中继服务器，则将其设置为可路由的子网范围。
例如：</p><p>常规客户端，只路由自身的流量：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>Address</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>192.0.2.3/32</span>
</span></span></code></pre></div><p>中继服务器，可以将流量转发到其他对等节点（peer）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>Address</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>192.0.2.1/24</span>
</span></span></code></pre></div><p>也可以指定多个子网或 IPv6 子网：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>Address</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>192.0.2.1/24,2001:DB8::/64</span>
</span></span></code></pre></div><h4 id=listenport>ListenPort</h4><p>当本地节点是中继服务器时，需要通过该参数指定端口来监听传入 VPN 连接，默认端口号是 51820。常规客户端不需要此选项。</p><h4 id=privatekey>PrivateKey</h4><p>本地节点的私钥，所有节点（包括中继服务器）都必须设置。不可与其他服务器共用。</p><p>私钥可通过命令 <code>wg genkey > example.key</code> 来生成。</p><h4 id=dns>DNS</h4><p>通过 DHCP 向客户端宣告 DNS 服务器。客户端将会使用这里指定的 DNS 服务器来处理 VPN 子网中的 DNS 请求，但也可以在系统中覆盖此选项。例如：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#75715e>#如果不配置则使用系统默认 DNS</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#可以指定单个 DNS：</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>DNS</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>1.1.1.1</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#也可以指定多个 DNS：</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>DNS</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>1.1.1.1,8.8.8.8</span>
</span></span></code></pre></div><h4 id=table>Table</h4><p>定义 VPN 子网使用的路由表，默认不需要设置。该参数有两个特殊的值需要注意：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span>    <span style=color:#a6e22e>Table</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>off : 禁止创建路由
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Table = auto（默认值） : 将路由添加到系统默认的 table 中，并启用对默认路由的特殊处理。</span>
</span></span></code></pre></div><p>例如：<code>Table = 1234</code></p><h4 id=mtu>MTU</h4><p>定义连接到对等节点（peer）的 MTU（Maximum Transmission Unit，最大传输单元），默认不需要设置，一般由系统自动确定。</p><h4 id=preup>PreUp</h4><p>启动 VPN 接口之前运行的命令。这个选项可以指定多次，按顺序执行。</p><p>例如：
添加路由：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span>    <span style=color:#a6e22e>PreUp</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>ip rule add ipproto tcp dport 22 table 1234</span>
</span></span></code></pre></div><h4 id=postup>PostUp</h4><p>启动 VPN 接口之后运行的命令。这个选项可以指定多次，按顺序执行。</p><p>例如：</p><pre><code>从文件或某个命令的输出中读取配置值：
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span>    <span style=color:#a6e22e>PostUp</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>wg set %i private-key /etc/wireguard/wg0.key &lt;(some command here)</span>
</span></span></code></pre></div><pre><code>添加一行日志到文件中：
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span>    <span style=color:#a6e22e>PostUp</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>echo &#34;$(date +%s) WireGuard Started&#34; &gt;&gt; /var/log/wireguard.log</span>
</span></span></code></pre></div><pre><code>调用 WebHook：
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span>    <span style=color:#a6e22e>PostUp</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>curl https://events.example.dev/wireguard/started</span>
</span></span></code></pre></div><pre><code>添加路由：
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span>    <span style=color:#a6e22e>PostUp</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>ip rule add ipproto tcp dport 22 table 1234</span>
</span></span></code></pre></div><pre><code>添加 iptables 规则，启用数据包转发：
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span>    <span style=color:#a6e22e>PostUp</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span>
</span></span></code></pre></div><pre><code>强制 WireGuard 重新解析对端域名的 IP 地址：
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span>    <span style=color:#a6e22e>PostUp</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>resolvectl domain %i &#34;~.&#34;; resolvectl dns %i 192.0.2.1; resolvectl dnssec %i yes</span>
</span></span></code></pre></div><h4 id=predown>PreDown</h4><p>停止 VPN 接口之前运行的命令。这个选项可以指定多次，按顺序执行。
例如：</p><pre><code>添加一行日志到文件中：
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span>    <span style=color:#a6e22e>PreDown</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>echo &#34;$(date +%s) WireGuard Going Down&#34; &gt;&gt; /var/log/wireguard.log</span>
</span></span></code></pre></div><h4 id=postdown>PostDown</h4><p>停止 VPN 接口之后运行的命令。这个选项可以指定多次，按顺序执行。
例如：</p><pre><code>添加一行日志到文件中：
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>PostDown</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>echo &#34;$(date +%s) WireGuard  Down&#34; &gt;&gt; /var/log/wireguard.log</span>
</span></span></code></pre></div><h4 id=peer>[Peer]</h4><p>定义能够为一个或多个地址路由流量的对等节点（peer）的 VPN 设置。对等节点（peer）可以是将流量转发到其他对等节点（peer）的中继服务器，也可以是通过公网或内网直连的客户端。</p><p>中继服务器必须将所有的客户端定义为对等节点（peer），除了中继服务器之外，其他客户端都不能将位于 NAT 后面的节点定义为对等节点（peer），因为路由不可达。对于那些只为自己路由流量的客户端，只需将中继服务器作为对等节点（peer），以及其他需要直接访问的节点。</p><p>配置示例：</p><p>对等节点（peer）是路由可达的客户端，只为自己路由流量</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[Peer]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Name = public-server2.example-vpn.dev</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Endpoint</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>public-server2.example-vpn.dev:51820</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PublicKey</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&lt;public key for public-server2.example-vpn.dev&gt;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>AllowedIPs</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>192.0.2.2/32</span>
</span></span></code></pre></div><p>对等节点（peer）是位于 NAT 后面的客户端，只为自己路由流量</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[Peer]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Name = home-server.example-vpn.dev</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Endpoint</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>home-server.example-vpn.dev:51820</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PublicKey</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&lt;public key for home-server.example-vpn.dev&gt;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>AllowedIPs</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>192.0.2.3/32</span>
</span></span></code></pre></div><p>对等节点（peer）是中继服务器，用来将流量转发到其他对等节点（peer）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[Peer]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Name = public-server1.example-vpn.tld</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Endpoint</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>public-server1.example-vpn.tld:51820</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PublicKey</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&lt;public key for public-server1.example-vpn.tld&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 路由整个 VPN 子网的流量</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>AllowedIPs</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>192.0.2.1/24</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PersistentKeepalive</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>25</span>
</span></span></code></pre></div><h4 id=endpoint>Endpoint</h4><p>指定远端对等节点（peer）的公网地址。如果对等节点（peer）位于 NAT 后面或者没有稳定的公网访问地址，就忽略这个字段。通常只需要指定中继服务器的 Endpoint，当然有稳定公网 IP 的节点也可以指定。例如：</p><p>通过 IP 指定：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>Endpoint</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>123.124.125.126:51820</span>
</span></span></code></pre></div><p>通过域名指定：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>Endpoint</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>public-server1.example-vpn.tld:51820</span>
</span></span></code></pre></div><h4 id=allowedips>AllowedIPs</h4><p>允许该对等节点（peer）发送过来的 VPN 流量中的源地址范围。同时这个字段也会作为本机路由表中 wg0 绑定的 IP 地址范围。如果对等节点（peer）是常规的客户端，则将其设置为节点本身的单个 IP；如果对等节点（peer）是中继服务器，则将其设置为可路由的子网范围。可以使用 , 来指定多个 IP 或子网范围。该字段也可以指定多次。</p><p>当决定如何对一个数据包进行路由时，系统首先会选择最具体的路由，如果不匹配再选择更宽泛的路由。例如，对于一个发往 192.0.2.3 的数据包，系统首先会寻找地址为 192.0.2.3/32 的对等节点（peer），如果没有再寻找地址为 192.0.2.1/24 的对等节点（peer），以此类推。</p><p>例如：</p><p>对等节点（peer）是常规客户端，只路由自身的流量：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>AllowedIPs</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>192.0.2.3/32</span>
</span></span></code></pre></div><p>对等节点（peer）是中继服务器，可以将流量转发到其他对等节点（peer）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>AllowedIPs</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>192.0.2.1/24</span>
</span></span></code></pre></div><p>对等节点（peer）是中继服务器，可以转发所有的流量，包括外网流量和 VPN 流量：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>AllowedIPs</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>0.0.0.0/0,::/0</span>
</span></span></code></pre></div><p>对等节点（peer）是中继服务器，可以路由其自身和其他对等节点（peer）的流量：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>AllowedIPs</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>192.0.2.3/32,192.0.2.4/32</span>
</span></span></code></pre></div><p>对等节点（peer）是中继服务器，可以路由其自身的流量和它所在的内网的流量：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>AllowedIPs</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>192.0.2.3/32,192.168.1.1/24</span>
</span></span></code></pre></div><h4 id=publickey>PublicKey</h4><p>对等节点（peer）的公钥，所有节点（包括中继服务器）都必须设置。可与其他对等节点（peer）共用同一个公钥。</p><p>公钥可通过命令 <code>wg pubkey &lt; example.key > example.key.pub</code> 来生成，其中 example.key 是上面生成的私钥。</p><h4 id=persistentkeepalive>PersistentKeepalive</h4><p>如果连接是从一个位于 NAT 后面的对等节点（peer）到一个公网可达的对等节点（peer），那么 NAT 后面的对等节点（peer）必须定期发送一个出站 ping 包来检查连通性，如果 IP 有变化，就会自动更新Endpoint。</p><p>例如：</p><p>本地节点与对等节点（peer）可直连：该字段不需要指定，因为不需要连接检查。</p><p>对等节点（peer）位于 NAT 后面：该字段不需要指定，因为维持连接是客户端（连接的发起方）的责任。</p><p>本地节点位于 NAT 后面，对等节点（peer）公网可达：需要指定该字段 PersistentKeepalive = 25，表示每隔 25 秒发送一次 ping 来检查连接。</p><h3 id=共享一个-peersconf-文件>共享一个 peers.conf 文件</h3><p>如果某个 peer 的公钥与本地接口的私钥能够配对，那么 WireGuard 会忽略该 <code>peer</code>。利用这个特性，我们可以在所有节点上共用同一个 <code>peer</code> 列表，每个节点只需要单独定义一个 <code>[Interface]</code> 就行了，即使列表中有本节点，也会被忽略。具体方式如下：</p><p>每个对等节点（peer）都有一个单独的 <code>/etc/wireguard/wg0.conf</code> 文件，只包含 <code>[Interface]</code> 部分的配置。</p><p>每个对等节点（peer）共用同一个 <code>/etc/wireguard/peers.conf</code> 文件，其中包含了所有的 peer。</p><p>Wg0.conf 文件中需要配置一个 PostUp 钩子，内容为</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>PostUp</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>wg addconf /etc/wireguard/peers.conf</span>
</span></span></code></pre></div></div></article></main><aside><div><div><h3>LATEST POSTS</h3></div><div><ul><li><a href=/article/2025/the_degree_confluence_project/>访问世界上每一个经纬度为整数的交叉点</a></li><li><a href=/article/2025/test_25/>测试服务器能否正常收发邮件</a></li><li><a href=/article/2025/nginx_too_many_open_files/>Nginx 出现 Too many open files 错误与修复</a></li><li><a href=/article/2025/ifconfig_interfaces/>Debian12 系统添加多个IP</a></li><li><a href=/article/2025/linux_curl/>linux测试url的访问速度</a></li></ul></div></div></aside><footer><p>&copy; 2025 <a href=https://blog.baicai.me/><b>baicai.me</b></a>.
<a href=/links/><b>友情链接</b></a>.
<a href=/index.xml><b>RSS</b></a>.</p></footer></body></html>