<!doctype html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=author content><meta property="og:url" content="https://blog.baicai.me/article/2023/quick_start/"><link rel=canonical href=https://blog.baicai.me/article/2023/quick_start/><style type=text/css>body{font-family:monospace}</style><title>K3s 快速入门指南:构建多云环境下的K3S集群</title>
<meta name=author content="白菜"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href="/css/baicai_custom.css?rnd=1743156732"></head><body><header>============<br>== <a href=https://blog.baicai.me/>白菜</a> ==<br>============<div style=float:right>一个勤奋的代码搬运工!</div><br><p><nav><a href=/><b>Start</b></a>.
<a href=/posts/><b>文章</b></a>.
<a href=/categories/><b>分类</b></a>.
<a href=/tags/><b>标签</b></a>.
<a href=/about/><b>关于</b></a>.</nav></p></header><main><article><h1>K3s 快速入门指南:构建多云环境下的K3S集群</h1><b><time>2023.09.28 20:29</time></b>
<a href=/tags/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB>技术分享</a>
<a href=/tags/k3s>k3s</a>
<a href=/tags/kubernetes>Kubernetes</a>
<a href=/tags/kubectl>kubectl</a><div><p>K3s 是轻量级的 Kubernetes。server最低只需要512M内存即可运行。</p><p>不同账号甚至不同云服务商， 内网是不通的。所以要想办法实现跨公网的容器网络通信，保障任意一台节点上的pod能访问任意节点上的pod和service，和正常的kubernetes集群体验一致。</p><p>参考入门指南和多云解决方案，重新整理</p><p>目标：实现混合云(腾讯云服务器+甲骨文服务器+微软Azure服务器)境下的K3S集群</p><h3 id=server安装>Server安装</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 局域网方案</span>
</span></span><span style=display:flex><span>curl -sfL https://get.k3s.io | sh -
</span></span><span style=display:flex><span><span style=color:#75715e># 多云安装方案</span>
</span></span><span style=display:flex><span>curl -sfL https://get.k3s.io | sh -s - --node-external-ip<span style=color:#f92672>=</span>Server公网地址 --flannel-backend<span style=color:#f92672>=</span>wireguard-native 
</span></span></code></pre></div><p>中国用户，可以使用以下方法加速安装：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 局域网方案</span>
</span></span><span style=display:flex><span>curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR<span style=color:#f92672>=</span>cn sh -
</span></span><span style=display:flex><span><span style=color:#75715e># 多云安装方案</span>
</span></span><span style=display:flex><span>curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR<span style=color:#f92672>=</span>cn  sh -s - --node-external-ip<span style=color:#f92672>=</span>Server公网地址 --flannel-backend<span style=color:#f92672>=</span>wireguard-native --flannel-external-ip
</span></span></code></pre></div><p>运行此安装后：</p><pre tabindex=0><code>K3s 服务将被配置为在节点重启后或进程崩溃或被杀死时自动重启。
将安装其他实用程序，包括 ```kubectl```、```crictl```、```ctr```、```k3s-killall.sh``` 和 ```k3s-uninstall.sh```。
kubeconfig 文件将写入到 ```/etc/rancher/k3s/k3s.yaml```，由 K3s 安装的 kubectl 将自动使用该文件。
</code></pre><h3 id=安装其他-agent-节点>安装其他 Agent 节点</h3><p>安装其他 Agent 节点并将它们添加到集群，请使用 K3S_URL 和 K3S_TOKEN 环境变量运行安装脚本</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 局域网方案</span>
</span></span><span style=display:flex><span>curl -sfL https://get.k3s.io | K3S_URL<span style=color:#f92672>=</span>https://myserver:6443 K3S_TOKEN<span style=color:#f92672>=</span>mynodetoken sh -
</span></span><span style=display:flex><span><span style=color:#75715e># 多云安装方案</span>
</span></span><span style=display:flex><span>curl -sfL https://get.k3s.io | K3S_URL<span style=color:#f92672>=</span>https://Server公网地址:6443 K3S_TOKEN<span style=color:#f92672>=</span>mynodetoken sh -s - --node-external-ip<span style=color:#f92672>=</span>Agent公网地址
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 局域网方案</span>
</span></span><span style=display:flex><span>curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR<span style=color:#f92672>=</span>cn K3S_URL<span style=color:#f92672>=</span>https://myserver:6443 K3S_TOKEN<span style=color:#f92672>=</span>mynodetoken sh -
</span></span><span style=display:flex><span><span style=color:#75715e># 多云安装方案</span>
</span></span><span style=display:flex><span>curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR<span style=color:#f92672>=</span>cn K3S_URL<span style=color:#f92672>=</span>https://Server公网地址:6443 K3S_TOKEN<span style=color:#f92672>=</span>mynodetoken sh -s - --node-external-ip<span style=color:#f92672>=</span>Agent公网地址
</span></span></code></pre></div><p>备注：
<code>K3S_URL</code> 参数会导致安装程序将 K3s 配置为 Agent 而不是 Server。K3s Agent 将注册到在 URL 上监听的 K3s Server。<code>K3S_TOKEN</code> 使用的值存储在 Server 节点上的 <code>/var/lib/rancher/k3s/server/node-token</code> 中。
每台主机必须具有唯一的主机名。如果你的计算机没有唯一的主机名，请传递 K3S_NODE_NAME 环境变量，并为每个节点提供一个有效且唯一的主机名。</p><h3 id=在本机访问k3s集群>在本机访问k3s集群</h3><p>安装kubectl</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew install kubectl
</span></span></code></pre></div><p>复制 Server 中 <code>/etc/rancher/k3s/k3s.yaml</code> 的内容</p><p>写入本机的<code>~/.kube/config</code>文件.</p><p>参考scp复制指令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>scp server:/etc/rancher/k3s/k3s.yaml ~/.kube/config
</span></span></code></pre></div><h3 id=测试指令>测试指令</h3><p>查看节点状态：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get node
</span></span><span style=display:flex><span>NAME            STATUS   ROLES                  AGE   VERSION
</span></span><span style=display:flex><span>vm-4-10-debian             Ready    &lt;none&gt;      35m   v1.27.6+k3s1
</span></span><span style=display:flex><span>vm-4-9-debian   Ready    control-plane,master   39m   v1.27.6+k3s1
</span></span></code></pre></div><p>检查跨网通讯：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get pod -A -o wide
</span></span><span style=display:flex><span>NAMESPACE     NAME                                     READY   STATUS      RESTARTS   AGE   IP          NODE            NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>kube-system   local-path-provisioner-957fdf8bc-gcgj4   1/1     Running     <span style=color:#ae81ff>0</span>          38m   10.42.0.5   vm-4-9-debian   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   coredns-77ccd57875-vsxmt                 1/1     Running     <span style=color:#ae81ff>0</span>          38m   10.42.0.6   vm-4-9-debian   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   helm-install-traefik-crd-sv9jh           0/1     Completed   <span style=color:#ae81ff>0</span>          38m   10.42.0.4   vm-4-9-debian   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   metrics-server-5f8b4ffd8-zd4db           1/1     Running     <span style=color:#ae81ff>0</span>          38m   10.42.0.3   vm-4-9-debian   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   helm-install-traefik-jp8sk               0/1     Completed   <span style=color:#ae81ff>2</span>          38m   10.42.0.2   vm-4-9-debian   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   svclb-traefik-0782c5d1-wr5kd             2/2     Running     <span style=color:#ae81ff>0</span>          37m   10.42.0.7   vm-4-9-debian   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   traefik-64f55bb67d-4lr2g                 1/1     Running     <span style=color:#ae81ff>0</span>          37m   10.42.0.8   vm-4-9-debian   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>kube-system   svclb-traefik-0782c5d1-444jv             2/2     Running     <span style=color:#ae81ff>0</span>          34m   10.42.1.2   vm-4-10-debian  &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>查看节点资源使用情况：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl top node
</span></span><span style=display:flex><span>NAME            CPU<span style=color:#f92672>(</span>cores<span style=color:#f92672>)</span>   CPU%        MEMORY<span style=color:#f92672>(</span>bytes<span style=color:#f92672>)</span>   MEMORY%     
</span></span><span style=display:flex><span>vm-4-9-debian   24m          2%          1369Mi          69%         
</span></span><span style=display:flex><span>vm-4-10-debian             &lt;unknown&gt;    &lt;unknown&gt;   &lt;unknown&gt;       &lt;unknown&gt; 
</span></span></code></pre></div><p>查看POD资源使用情况:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl top pod -A
</span></span><span style=display:flex><span>NAMESPACE     NAME                                     CPU<span style=color:#f92672>(</span>cores<span style=color:#f92672>)</span>   MEMORY<span style=color:#f92672>(</span>bytes<span style=color:#f92672>)</span>   
</span></span><span style=display:flex><span>kube-system   coredns-77ccd57875-vsxmt                 1m           20Mi            
</span></span><span style=display:flex><span>kube-system   local-path-provisioner-957fdf8bc-gcgj4   1m           14Mi            
</span></span><span style=display:flex><span>kube-system   metrics-server-5f8b4ffd8-zd4db           3m           24Mi            
</span></span><span style=display:flex><span>kube-system   svclb-traefik-0782c5d1-wr5kd             0m           0Mi             
</span></span><span style=display:flex><span>kube-system   traefik-64f55bb67d-4lr2g                 1m           33Mi
</span></span></code></pre></div><p>到此k3s集群部署完成， 如果有更多的主机，可以重复agent的配置步骤进行添加。</p><h3 id=k3s-server-节点的入站规则>K3s Server 节点的入站规则</h3><table><thead><tr><th style=text-align:left>协议</th><th style=text-align:center>端口</th><th style=text-align:center>源</th><th style=text-align:center>目标</th><th style=text-align:left>描述</th></tr></thead><tbody><tr><td style=text-align:left>TCP</td><td style=text-align:center>2379-2380</td><td style=text-align:center>Servers</td><td style=text-align:center>Servers</td><td style=text-align:left>只有具有嵌入式 etcd 的 HA 需要</td></tr><tr><td style=text-align:left>TCP</td><td style=text-align:center>6443</td><td style=text-align:center>Agents</td><td style=text-align:center>Servers</td><td style=text-align:left>K3s supervisor 和 Kubernetes API Server</td></tr><tr><td style=text-align:left>UDP</td><td style=text-align:center>8472</td><td style=text-align:center>所有节点</td><td style=text-align:center>所有节点</td><td style=text-align:left>只有 Flannel VXLAN 需要</td></tr><tr><td style=text-align:left>TCP</td><td style=text-align:center>10250</td><td style=text-align:center>所有节点</td><td style=text-align:center>所有节点</td><td style=text-align:left>Kubelet 指标</td></tr><tr><td style=text-align:left>UDP</td><td style=text-align:center>51820</td><td style=text-align:center>所有节点</td><td style=text-align:center>所有节点</td><td style=text-align:left>只有使用 IPv4 的 Flannel Wireguard 才需要</td></tr><tr><td style=text-align:left>UDP</td><td style=text-align:center>51821</td><td style=text-align:center>所有节点</td><td style=text-align:center>所有节点</td><td style=text-align:left>只有使用 IPv6 的 Flannel Wireguard 才需要</td></tr></tbody></table><p>所有出站流量通常都是允许的。</p><h3 id=参考>参考：</h3><p><a href=https://docs.k3s.io/zh/quick-start>快速入门指南</a></p><p><a href=https://docs.k3s.io/zh/installation/network-options#%E5%B5%8C%E5%85%A5%E5%BC%8F-k3s-%E5%A4%9A%E4%BA%91%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88>嵌入式 k3s 多云解决方案</a></p></div></article></main><aside><div><div><h3>LATEST POSTS</h3></div><div><ul><li><a href=/article/2025/the_degree_confluence_project/>访问世界上每一个经纬度为整数的交叉点</a></li><li><a href=/article/2025/test_25/>测试服务器能否正常收发邮件</a></li><li><a href=/article/2025/nginx_too_many_open_files/>Nginx 出现 Too many open files 错误与修复</a></li><li><a href=/article/2025/ifconfig_interfaces/>Debian12 系统添加多个IP</a></li><li><a href=/article/2025/linux_curl/>linux测试url的访问速度</a></li></ul></div></div></aside><footer><p>&copy; 2025 <a href=https://blog.baicai.me/><b>baicai.me</b></a>.
<a href=/links/><b>友情链接</b></a>.
<a href=/index.xml><b>RSS</b></a>.</p></footer></body></html>